bootstrap: docker
from: ubuntu:24.04

%files
    requirements.txt /opt/requirements.txt

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    echo "deb http://archive.ubuntu.com/ubuntu noble universe" >> /etc/apt/sources.list
    apt-get update

    apt-get install -y python3-dev python3-pip python3-full swig git

    python3 -m venv /venv
    . /venv/bin/activate

    # Install setuptools and wheel first
    pip install --upgrade pip setuptools wheel

    # Install PyTorch with CUDA 12.6 (supports compute capability 6.1 for GTX 1080 Ti)
    pip install torch==2.7.1 torchvision==0.22.1 torchaudio==2.7.1 --index-url https://download.pytorch.org/whl/cu126

    # Install hockey environment (must be done separately as it's from git)
    pip install "hockey @ git+https://git@github.com/martius-lab/hockey-env.git"

    # Install requirements from /opt/requirements.txt (copied via %files section)
    echo "Checking for requirements.txt..."
    
    if [ -f /opt/requirements.txt ]; then
        echo "✓ Found requirements.txt at /opt/requirements.txt"
        echo "Total lines in requirements.txt: $(wc -l < /opt/requirements.txt)"
        echo "Filtering out rl_hockey, hockey, torch packages, triton, and CUDA packages..."
        
        # Filter requirements and save to /opt/filtered_requirements.txt
        grep -v "rl_hockey" /opt/requirements.txt | \
        grep -v "^hockey" | \
        grep -v "^torch" | \
        grep -v "^triton" | \
        grep -v "^nvidia-" > /opt/filtered_requirements.txt
        
        echo "Packages to install: $(wc -l < /opt/filtered_requirements.txt)"
        echo "First few packages to install:"
        head -5 /opt/filtered_requirements.txt
        echo ""
        echo "Installing packages from requirements.txt..."
        pip install -r /opt/filtered_requirements.txt
        echo "✓ Finished installing requirements.txt packages"
        rm -f /opt/filtered_requirements.txt
    else
        echo "ERROR: requirements.txt not found at /opt/requirements.txt"
        exit 1
    fi

    # cleanup
    apt-get clean
    pip cache purge

%runscript
    . /venv/bin/activate
    "$@"






